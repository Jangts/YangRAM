<html>

<head>
    <title>ColorPicker</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <script src="http://interblocks.nidn.yangram.ni/src/iblock.js"></script>
    <style>
        #colors {
            cursor: crosshair;
        }
        
        #hue {
            cursor: default;
        }
    </style>
</head>

<body>
    <svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="230" height="155">
        <g id="colors"></g>
        <g id="hue"></g>
    </svg>

    <script>
        iBlock(['$_/dom/Elements/', '$_/util/Color.Cls'], (_) => {
            $ = _.dom.select;
            var buildWebHues = () => {
                var y, hues = '',
                    height = 155 / 31;
                for (var h = 0; h <= 360; h += 12) {
                    y = 150 - (h / 12) * height;
                    hues += '<rect x="210" y="' + y + '" width="20" height="' + height + '" style="fill:hsl(' + h + ',100%,50%);" class="websafecolor hue' + h + '" data-hue="' + h + '"></rect>';
                }
                $('#hue').html(hues);

                $('#hue rect.websafecolor').click(function() {
                    var h = $(this).data('hue');
                    buildWebColors(h);
                });
                buildWebColors(0);
            }
            var buildWebColors = (h) => {
                var x, y, colors, rows = [],
                    width = 202 / 101,
                    height = 155 / 5;
                for (var b = 100; b >= 0; b -= 20) {
                    y = 155 - parseInt((b / 20 + 0.5) * height);
                    if (y < 0) {
                        _hei = height + y;
                        y = 0;
                    } else if (y + height > 155) {
                        _hei = 155 - y;
                    } else {
                        _hei = height;
                    }
                    colors = '';
                    for (var s = 0; s <= 100; s++) {
                        var hsl = _.util.Color.hsb2HSL(h, s, b),
                            rgb = _.util.Color.hsl2SafeRGB(h, hsl[1], hsl[2]);
                        x = s * width,
                            colors += '<rect x="' + x + '" y="' + y + '" width="' + width + '" height="' + _hei + '" style="fill:rgb(' + parseInt(rgb[0]) + ',' + parseInt(rgb[1]) + ',' + parseInt(rgb[2]) + ');" data-rgb="rgb(' + parseInt(rgb[0]) + ',' + parseInt(rgb[1]) + ',' + parseInt(rgb[2]) + ')"></rect>';
                    }
                    rows.push('<g class="websafecolor">' + colors + '</g>');
                }
                //console.log(h);
                $('#hue .current').removeClass('current');
                $('#hue .hue' + h).addClass('current');
                $('#colors').html(rows.join(''));
                $('#colors g.websafecolor rect').click(function() {
                    var rgb = $(this).data('rgb');
                    hex = _.util.Color.rgbFormat(rgb, 'hex6');
                    console.log(rgb, hex);
                });
            };
            console.log(Date.parse(new Date()));
            buildWebHues();
            console.log(Date.parse(new Date()));
        }, true);
    </script>
</body>

</html>