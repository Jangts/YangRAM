<html>

<head>
    <title>ColorPicker</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <script src="http://interblocks.nidn.yangram.ni/src/iblock.js"></script>
    <style>
        #colors {
            cursor: crosshair;
        }
        
        #hue {
            cursor: default;
        }
    </style>
</head>

<body>
    <svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="460" height="420">
        <g id="colors"></g>
        <g id="hue"></g>
    </svg>

    <script>
        iBlock(['$_/dom/Elements/', '$_/util/Color.Cls'], (_) => {
            $ = _.dom.select;

            var buildHues = () => {
                var y, hues = '';
                for (var h = 360; h >= 0; h -= 12) {
                    y = 384 - h;
                    hues += '<rect x="422" y="' + y + '" width="30" height="12" style="fill:hsl(' + h + ',100%,50%);" class="websafecolor hue' + h + '" data-hue="' + h + '"></rect>';
                }
                $('#hue').html(hues);

                $('#hue rect.websafecolor').click(function() {
                    var h = $(this).data('hue');
                    //console.log(h);
                    buildColors(h);
                });
                buildColors(0);
            }

            var buildTrueHues = () => {
                var y, hues = '';
                for (var h = 360; h >= 0; h--) {
                    y = 390 - h;
                    hues += '<rect x="422" y="' + y + '" width="30" height="1" style="fill:hsl(' + h + ',100%,50%);" class="truecolor hue' + h + '" data-hue="' + h + '"></rect>';
                }
                $('#hue').html(hues);

                $('#hue rect.truecolor').click(function() {
                    var h = $(this).data('hue');
                    //console.log(h);
                    buildTrueColors(h);
                });
                buildTrueColors(0);
            }

            var buildColors = (h) => {
                var x, y, colors, rows = [];
                for (var b = 100; b >= 0; b -= 20) {
                    y = 344 - b * 3.35,
                        colors = '';
                    for (var s = 0; s <= 100; s++) {
                        var hsl = _.util.Color.hsb2HSL(h, s, b),
                            rgb = _.util.Color.hsl2SafeRGB(h, hsl[1], hsl[2]);
                        x = s * 4 + 9,
                            colors += '<rect x="' + x + '" y="' + y + '" width="4" height="67" style="fill:rgb(' + parseInt(rgb[0]) + ',' + parseInt(rgb[1]) + ',' + parseInt(rgb[2]) + ');" data-rgb="rgb(' + parseInt(rgb[0]) + ',' + parseInt(rgb[1]) + ',' + parseInt(rgb[2]) + ')"></rect>';
                    }
                    rows.push('<g class="websafecolor">' + colors + '</g>');
                }
                //console.log(h);
                $('#hue .current').removeClass('current');
                $('#hue .hue' + h).addClass('current');
                $('#colors').html(rows.join(''));
                $('#colors g.websafecolor rect').click(function() {
                    var rgb = $(this).data('rgb');
                    hex = _.util.Color.rgbFormat(rgb, 'hex6');
                    console.log(rgb, hex);
                });
            };
            var buildTrueColors = (h) => {
                var x, y, colors, rows = [];
                for (var b = 100; b >= 0; b--) {
                    y = 408 - b * 4,
                        colors = '';
                    for (var s = 0; s <= 100; s++) {
                        var hsl = _.util.Color.hsb2HSL(h, s, b);
                        x = s * 4 + 8,
                            colors += '<rect x="' + x + '" y="' + y + '" width="4" height="4" style="fill:hsl(' + h + ',' + hsl[1] + '%,' + hsl[2] + '%);" data-h="' + h + '" data-s="' + hsl[1] + '" data-l="' + hsl[2] + '"></rect>';
                    }
                    rows.push('<g class="truecolor">' + colors + '</g>');
                }
                //console.log(h);
                $('#hue .current').removeClass('current');
                $('#hue .hue' + h).addClass('current');
                $('#colors').html(rows.join(''));
                $('#colors g.truecolor rect').click(function() {
                    var h = parseFloat($(this).data('h')),
                        s = parseFloat($(this).data('s')),
                        l = parseFloat($(this).data('l')),
                        rgb = _.util.Color.hsl2RGB(h, s, l);
                    // console.log(h, s, l, rgb);
                    hex = _.util.Color.rgbFormat('rgb(' + rgb.join(',') + ')', 'hex6');
                    console.log(hex);
                });
            };
            console.log(Date.parse(new Date()));
            buildHues();
            // buildTrueHues();
            console.log(Date.parse(new Date()));
        }, true);
    </script>
</body>

</html>